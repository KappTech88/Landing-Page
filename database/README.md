# Claims Restoration CRM - Database

## üìÅ Structure

```
/database
‚îú‚îÄ‚îÄ /schemas              # SQL migration files (001-008)
‚îÇ   ‚îú‚îÄ‚îÄ 001-init.sql              # Organizations, users, roles (multi-tenancy)
‚îÇ   ‚îú‚îÄ‚îÄ 002-claims.sql            # Claims and properties
‚îÇ   ‚îú‚îÄ‚îÄ 003-estimates.sql         # Estimates, line items, materials, labor
‚îÇ   ‚îú‚îÄ‚îÄ 004-photos.sql            # Photo/document management
‚îÇ   ‚îú‚îÄ‚îÄ 005-invoices.sql          # Invoices and payments
‚îÇ   ‚îú‚îÄ‚îÄ 006-insurers.sql          # Insurance companies and adjusters
‚îÇ   ‚îú‚îÄ‚îÄ 007-status-history.sql    # Audit trail and activity logs
‚îÇ   ‚îî‚îÄ‚îÄ 008-rls-policies.sql      # Row Level Security policies
‚îÇ
‚îú‚îÄ‚îÄ /docs                 # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ README-for-AI.md          # ‚≠ê AI agent reference guide
‚îÇ   ‚îú‚îÄ‚îÄ SETUP.md                  # Step-by-step setup instructions
‚îÇ   ‚îú‚îÄ‚îÄ NEXTJS_MIGRATION_PLAN.md  # Vite ‚Üí Next.js migration guide
‚îÇ   ‚îî‚îÄ‚îÄ GOOGLE_WORKSPACE_INTEGRATION.md  # Gmail API setup
‚îÇ
‚îú‚îÄ‚îÄ /examples             # Example code and data
‚îÇ   ‚îú‚îÄ‚îÄ seed-data.sql             # Test data for development
‚îÇ   ‚îú‚îÄ‚îÄ sample-queries.sql        # Common query patterns
‚îÇ   ‚îî‚îÄ‚îÄ supabase-client.ts        # TypeScript client examples
‚îÇ
‚îú‚îÄ‚îÄ /json_schema          # Machine-readable schema
‚îÇ   ‚îî‚îÄ‚îÄ schema.json               # JSON schema for AI tools
‚îÇ
‚îî‚îÄ‚îÄ /migrations           # Auto-generated Supabase migrations
    ‚îî‚îÄ‚îÄ (generated by Supabase CLI)
```

---

## üéØ Quick Start

### Option 1: Remote Supabase (Recommended for Getting Started)

1. **Create Supabase Project**
   - Go to [https://supabase.com](https://supabase.com)
   - Create new project
   - Save credentials

2. **Apply Schema**
   - Use Supabase SQL Editor
   - Run schemas in order: `001-init.sql` ‚Üí `008-rls-policies.sql`

3. **Generate Types**
   ```bash
   npx supabase gen types typescript --project-id YOUR_PROJECT_REF > types/database.ts
   ```

### Option 2: Local Supabase (Advanced)

**Prerequisites**: Docker + Supabase CLI

```bash
# Install Supabase CLI
npm install -g supabase

# Initialize project
supabase init

# Start local Supabase
supabase start

# Apply schemas
cp database/schemas/*.sql supabase/migrations/
supabase db reset
```

---

## üóÇÔ∏è Database Architecture

### Multi-Tenancy Model

```
Organizations (Companies)
    ‚Üì
Users (via user_organization_roles junction)
    ‚Üì (belong to)
Roles (System + Custom)
    ‚Üì (have)
Permissions (JSONB)
```

**Key Concepts**:
- Every table has `organization_id` for data isolation
- Users can belong to multiple orgs with different roles
- Row Level Security (RLS) enforces access control
- Super admins bypass RLS (Estimate Reliance staff)

### Entity Relationships

```
Organizations
    ‚Üì
Claims ‚Üí Properties (1:1)
    ‚Üì
    ‚îú‚îÄ‚îÄ Estimates ‚Üí Line Items (1:many)
    ‚îú‚îÄ‚îÄ Photos ‚Üí Storage (Supabase)
    ‚îú‚îÄ‚îÄ Documents ‚Üí Storage (Supabase)
    ‚îú‚îÄ‚îÄ Invoices ‚Üí Payments (1:many)
    ‚îú‚îÄ‚îÄ Insurance Companies ‚Üí Adjusters
    ‚îî‚îÄ‚îÄ Status History (audit trail)
```

---

## üìã Schema Files

### 001-init.sql
**Organizations, Users, Roles**

Creates:
- `organizations` - Multi-tenant isolation
- `users` - Links to Supabase Auth
- `roles` - System + custom roles
- `user_organization_roles` - Many-to-many junction

**Key Features**:
- System roles: super_admin, admin, contractor, estimator, client
- Custom role support per organization
- JSONB permissions for granular access control
- Google Workspace OAuth fields

### 002-claims.sql
**Claims & Properties**

Creates:
- `claims` - Central project tracking
- `properties` - Property details (1:1 with claims)
- `claim_contractors` - Multiple contractors per claim

**Key Features**:
- 14-stage workflow (open ‚Üí closed)
- Auto-date tracking via helper function
- Full-text search on descriptions
- Soft delete support

### 003-estimates.sql
**Estimates & Financial Tracking**

Creates:
- `estimates` - Estimate versions
- `estimate_line_items` - Hierarchical line items
- `materials` - Procurement tracking
- `labor` - Time tracking

**Key Features**:
- Auto-recalculating totals (via triggers)
- Xactimate integration fields
- RCV/ACV depreciation support
- Version control with parent links

### 004-photos.sql
**Photo & Document Management**

Creates:
- `photos` - Supabase Storage references
- `photo_albums` - Organization
- `documents` - Non-photo files

**Key Features**:
- Organized by category/subcategory
- Tagging system for search
- EXIF data storage
- Client visibility controls

### 005-invoices.sql
**Billing & Payments**

Creates:
- `invoices` - Invoice management
- `invoice_line_items` - Line-item detail
- `payments` - Payment tracking

**Key Features**:
- Auto-calculating totals
- Auto-updating payment status
- Overdue detection
- Payment processor support (Stripe/Square)

### 006-insurers.sql
**Insurance Integration**

Creates:
- `insurance_companies` - Master list
- `insurance_adjusters` - Contact database
- `claim_insurers` - Claim-insurance links
- `correspondence` - Communication log

**Key Features**:
- Performance tracking (response times, approval rates)
- Follow-up scheduling
- Denial/dispute tracking
- Multi-insurer support per claim

### 007-status-history.sql
**Audit Trail**

Creates:
- `status_history` - All status changes
- `activity_log` - User actions
- `notes` - User-created notes
- `notifications` - In-app notifications

**Key Features**:
- Auto-logging via triggers
- @mention support in notes
- Multi-channel notifications (email/SMS/push)
- Follow-up reminders

### 008-rls-policies.sql
**Row Level Security**

Implements:
- Organization isolation policies
- Role-based access policies
- Helper functions for permission checks
- Service role bypass

**Security Model**:
```sql
-- Users only see their org's data
WHERE organization_id = ANY(auth.user_organization_ids())

-- Check permissions
WHERE auth.user_has_permission(org_id, 'claims', 'create')

-- Super admin bypass
WHERE auth.is_super_admin() OR ...
```

---

## üîß Helper Functions

All schemas include helper functions for common operations:

```sql
-- Organization & Role Management
SELECT auth.user_organization_ids();
SELECT auth.is_super_admin();
SELECT auth.is_org_admin($org_id);
SELECT auth.user_has_permission($org_id, 'resource', 'action');

-- Claims
SELECT get_user_claims($user_id, $org_id);
SELECT update_claim_status($claim_id, 'approved', $user_id);

-- Estimates
SELECT recalculate_estimate_totals($estimate_id);

-- Photos
SELECT get_claim_photos_by_category($claim_id);
SELECT generate_photo_storage_path($org_id, $claim_id, $photo_id, 'jpg');

-- Invoices
SELECT recalculate_invoice_totals($invoice_id);
SELECT update_overdue_invoices(); -- Run nightly

-- Status History
SELECT log_status_change('claims', $claim_id, 'status', 'old', 'new', $user_id);

-- Notifications
SELECT create_notification($user_id, $org_id, 'claim_assigned', 'Title', 'Message');
```

---

## üîí Security

### Row Level Security (RLS)

**Enabled on ALL tables** - Users can only access:
1. Data in their organization(s)
2. Data they have permission to access (based on role)
3. Public data (if explicitly marked)

**Exception**: Service role bypasses RLS (for admin operations)

### Best Practices

1. **NEVER hard delete** - Use `deleted_at` timestamp
2. **ALWAYS filter by organization_id** - Even if RLS is enabled
3. **Use helper functions** - They're secure and optimized
4. **Encrypt sensitive data** - Especially OAuth tokens
5. **Log all changes** - Use `status_history` table

---

## üìä Performance

### Indexes Created

- All foreign keys indexed
- Full-text search on: claims, properties, photos, documents
- GIN indexes on JSONB columns
- Partial indexes on soft-deleted records
- Geospatial indexes on property locations

### Optimization Tips

1. Always include `deleted_at IS NULL` in queries
2. Use generated columns (`full_address`, `full_name`)
3. Leverage full-text search for text queries
4. Use transactions for multi-table operations
5. Monitor slow queries in Supabase dashboard

---

## üöÄ Next Steps

1. ‚úÖ **Database structure created**
2. ‚Üí **Install Dependencies**: See `package.json` changes needed
3. ‚Üí **Set up Supabase**: Remote or local
4. ‚Üí **Apply Schemas**: Run migrations in order
5. ‚Üí **Generate Types**: `supabase gen types typescript`
6. ‚Üí **Migrate to Next.js**: Follow `NEXTJS_MIGRATION_PLAN.md`
7. ‚Üí **Set up Auth**: Configure Supabase Auth
8. ‚Üí **Configure Storage**: Create buckets for photos/documents
9. ‚Üí **Google Workspace**: Follow `GOOGLE_WORKSPACE_INTEGRATION.md`
10. ‚Üí **Deploy**: Push to Vercel with environment variables

---

## üìö Documentation

- **For AI Agents**: `docs/README-for-AI.md` - Comprehensive schema reference
- **For Developers**: `docs/SETUP.md` - Step-by-step setup
- **For Migration**: `docs/NEXTJS_MIGRATION_PLAN.md` - Vite ‚Üí Next.js guide
- **For Email**: `docs/GOOGLE_WORKSPACE_INTEGRATION.md` - Gmail API setup

---

## üÜò Support

- **Supabase Docs**: [https://supabase.com/docs](https://supabase.com/docs)
- **PostgreSQL Docs**: [https://www.postgresql.org/docs/](https://www.postgresql.org/docs/)
- **Schema Issues**: Check `database/schemas/` comments
- **RLS Issues**: Review `database/schemas/008-rls-policies.sql`

---

**Database Version**: 1.0.0
**Last Updated**: 2025-11-25
**PostgreSQL**: 15+
**Supabase**: Latest
